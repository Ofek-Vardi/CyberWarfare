#!/bin/bash

function nseExploit()
{
	# Iterate over each pair (target, port) found
	# Loop over all targets found with open ports
	for line in $(cat irEnumeration.csv 2>/dev/null)
	do
		if [ "$line" != "" ]
		then
			ip=$(echo "$line" | awk -F"," '{print $1}')
			port=$(echo "$line" | awk -F"," '{print $2}')
			service=$(echo "$line" | awk -F"," '{print $3}')
			# Loop over all scripts relevant for the scanned service
			for script in $(find /usr/share/nmap/scripts -name *$service* -type f)
			do
				# Extract the categories of each script
				categories=$(nmap --script-help $script | grep Categories)
				# Only run exploit scripts
				if [ "$(echo "$categories" | grep exploit)" != "" ]
				then
					# Extract script name into "$scriptName" (Full name), and "$name" (without the '.nse' suffix)
					scriptName=$(echo "$script" | awk -F "/" '{print $6}')
					name=${scriptName:0: -4}
					# Run the script
					scriptRes=$(nmap -sV $ip -p $port --script=$script 2>/dev/null | grep -E "^\|")
					# Create tile to print at the start of result
					title="$ip::$port"
					# Only save unique results which are not empty
					if [ "$scriptRes" != "" -a  "$(cat nseExploit.txt | grep "$title::$name")" == "" ]
					then
						# Starting line (Used for searching through results)
						echo "$title::$name" >> nseExploit.txt
						# Script result
						echo "$scriptRes" >> nseExploit.txt
						# Final line (Used for searching through results)
						echo "END" >> nseExploit.txt
					fi
				fi
			done
		fi
	done
}

orange='\033[0;33m'
clear='\033[0m'
ORG=$IFS
IFS=$'\n'
# Run NSE exploit scripts on all targets found with open ports
nseExploit
IFS=$ORG
